<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Калькулятор ціни</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;background:#f7f7f8;color:#111}
    .card{max-width:640px;margin:0 auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 6px 24px rgba(20,20,30,0.06)}
    h1{margin:0 0 12px;font-size:20px} label{display:block;margin-top:12px;font-weight:600}
    input[type=number], input[list], select, .country-input {width:100%;box-sizing:border-box;padding:8px 10px;margin-top:6px;font-size:16px;border:1px solid #dcdde1;border-radius:6px;background:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap} .row>div{flex:1;min-width:120px;border:1.5px solid #e0e0e0;border-radius:8px;padding:12px 10px 4px;box-shadow:0 2px 8px rgba(20,20,30,0.03)}
    .result{margin-top:18px;padding:12px;background:#f0f8ff;border:1px solid #dbeefe;border-radius:6px}
    .formula{font-family:monospace;background:#f4f4f6;padding:6px;border-radius:6px;display:inline-block}
    .muted{color:#666;font-size:14px} .note{margin-top:8px;color:#444}

    /* desktop dropdown styles (shared) */
    .autocomplete-wrapper{position:relative}
    .dropdown{position:absolute;left:0;right:0;margin-top:6px;border:1px solid #e0e0e0;background:#fff;border-radius:8px;max-height:240px;overflow:auto;box-shadow:0 8px 30px rgba(20,20,30,0.08);list-style:none;padding:6px 0;margin:0;z-index:1000}
    .dropdown li{padding:8px 12px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dropdown li:hover, .dropdown li[aria-selected="true"]{background:#f5f7fa}

    /* show select on small screens */
    #countrySelect, label[for=countrySelect]{display:none}
    @media (max-width:768px){ #countryInput, label[for=countryInput]{display:none} #countrySelect, label[for=countrySelect]{display:block} }
    @media (max-width:600px){body{margin:8px}.card{padding:12px}h1{font-size:18px}input,select{font-size:14px}}
  </style>
</head>
<body>
  <main class="card">
    <h1>Калькулятор ціни</h1>
    <p class="muted">Введіть розміри в сантиметрах та фактичну вагу в кілограмах.</p>

    <div class="row">
      <div>
        <label for="length">Довжина (cm)</label>
        <input id="length" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="40">
      </div>
      <div>
        <label for="width">Ширина (cm)</label>
        <input id="width" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="30">
      </div>
      <div>
        <label for="height">Висота (cm)</label>
        <input id="height" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="20">
      </div>
    </div>

    <label for="weight">Фактична вага (kg)</label>
    <input id="weight" type="number" inputmode="decimal" pattern="[0-9]*" step="any" min="0" placeholder="2.5">

    <!-- Desktop: input + datalist (visible on desktop) -->
    <label for="countryInput">Країна одержувача</label>
    <div class="autocomplete-wrapper">
      <input id="countryInput" list="countries" placeholder="Polska" autocomplete="off">
      <datalist id="countries"></datalist>
      <!-- desktop dropdown (injected and used only on non-mobile) -->
    </div>

    <!-- Mobile: select (visible on mobile) -->
    <label for="countrySelect">Країна одержувача</label>
    <select id="countrySelect">
      <option value="" disabled selected>Завантаження…</option>
    </select>

    <div class="result" aria-live="polite">
      <div class="note">Формула: <span class="formula">(<span id="f-l">довжина</span> × <span id="f-w">ширина</span> × <span id="f-h">висота</span>) ÷ 4000</span></div>
      <div style="margin-top:8px"><strong>Об'ємна вага:</strong> <span id="volumetric">—</span> <span class="muted">kg</span></div>
      <div style="margin-top:8px"><strong>Платна вага:</strong> <span id="billable">—</span> <span class="muted">kg</span></div>
      <div style="margin-top:8px"><strong>Ціна:</strong> <span id="price">—</span> <span class="muted">PLN</span></div>
    </div>
  </main>

  <script>
    // Elements
    const lengthEl = document.getElementById('length'),
          widthEl = document.getElementById('width'),
          heightEl = document.getElementById('height'),
          weightEl = document.getElementById('weight'),
          volumetricEl = document.getElementById('volumetric'),
          billableEl = document.getElementById('billable'),
          priceEl = document.getElementById('price'),
          fL = document.getElementById('f-l'),
          fW = document.getElementById('f-w'),
          fH = document.getElementById('f-h');

    const countryInput = document.getElementById('countryInput'),
          countrySelect = document.getElementById('countrySelect'),
          datalist = document.getElementById('countries');

    // Data
    let countries = [], ratesMap = {}, aliasMap = {};
    const fallbackRate = {s:100, m:150, over10:300, perKg:8};

    // Utils
    const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    const debounce = (fn, ms=160)=>{ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; };
    const parseNumber = el => { const v = parseFloat(el.value); return Number.isFinite(v) ? v : 0; };
    const formatNumber = v => (Math.round(v*100)/100).toFixed(2);
    const normalize = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();

    // Load data
    async function loadData(){
      try {
        const [r, a] = await Promise.all([
          fetch('./rates.json').then(x => x.ok ? x.json() : Promise.reject('rates.json')),
          fetch('./rates_aliases.json').then(x => x.ok ? x.json() : Promise.reject('rates_aliases.json'))
        ]);
        countries = r.map(i=>i.country);
        r.forEach(i=> ratesMap[i.country] = i);
        aliasMap = Object.keys(a||{}).reduce((acc,k)=>{ acc[k.toLowerCase()]=a[k]; return acc; },{});
        // fill datalist and select efficiently
        const fragD = document.createDocumentFragment();
        const fragS = document.createDocumentFragment();
        countries.forEach(name=>{
          const o = document.createElement('option'); o.value = name; fragD.appendChild(o);
          const s = document.createElement('option'); s.value = name; s.textContent = name; fragS.appendChild(s);
        });
        datalist.appendChild(fragD);
        countrySelect.innerHTML = ''; countrySelect.appendChild(fragS);

        // prefills
        const initial = ratesMap['Polska'] ? 'Polska' : (countries[0]||'');
        if (initial){ countryInput.value = initial; countrySelect.value = initial; }
      } catch(err){
        console.error('Load error', err);
        countrySelect.innerHTML = '<option value="" disabled selected>Не вдалося завантажити дані</option>';
      } finally { compute(); }
    }

    // Resolve country via aliases / case-insensitive
    function resolveCountry(input){
      if (!input) return '';
      if (ratesMap[input]) return input;
      const exact = Object.keys(ratesMap).find(c=>c.toLowerCase()===input.toLowerCase());
      if (exact) return exact;
      const alias = aliasMap[input.toLowerCase()];
      return alias && ratesMap[alias] ? alias : '';
    }

    // Sync functions
    function syncCountryToSelect(){
      const resolved = resolveCountry(countryInput.value);
      if (resolved && countrySelect.value !== resolved) countrySelect.value = resolved;
    }
    function syncSelectToInput(){ if (countrySelect.value && countryInput.value !== countrySelect.value) countryInput.value = countrySelect.value; }

    // Compute price
    function compute(){
      const L = parseNumber(lengthEl), W = parseNumber(widthEl), H = parseNumber(heightEl);
      const vol = (L*W*H)/4000;
      if (!L || !W || !H){ volumetricEl.textContent = billableEl.textContent = priceEl.textContent = '—'; return; }
      volumetricEl.textContent = formatNumber(vol);
      const actual = parseNumber(weightEl), billable = Math.max(vol, actual);
      billableEl.textContent = formatNumber(billable);

      const userInput = countryInput.value || countrySelect.value || '';
      const r = ratesMap[resolveCountry(userInput)] || fallbackRate;
      let price = billable <= 2 ? r.s : billable <= 10 ? r.m : r.over10 + (Math.ceil(billable)-10)*r.perKg;
      priceEl.textContent = billable > 10 ? `${formatNumber(price)} (10 кг = ${r.over10}, понад 10 кг = ${r.perKg})` : formatNumber(price);
    }

    // Wire inputs
    function bindEvents(){
      [lengthEl,widthEl,heightEl,weightEl].forEach(el=>el.addEventListener('input', ()=>{ updateFormulaFields(); compute(); }));
      countryInput.addEventListener('input', ()=>{ syncCountryToSelect(); compute(); });
      countryInput.addEventListener('change', ()=>{ syncCountryToSelect(); compute(); });
      countrySelect.addEventListener('change', ()=>{ syncSelectToInput(); compute(); });
    }

    function updateFormulaFields(){
      fL.textContent = lengthEl.value || 'довжина';
      fW.textContent = widthEl.value || 'ширина';
      fH.textContent = heightEl.value || 'висота';
    }

    // --- Desktop dropdown: shows suggestions even when field already filled ---
    (function integrateDesktopDropdown(){
      if (isMobile) return;
      const wrapper = countryInput.parentElement;
      wrapper.style.position = wrapper.style.position || 'relative';
      const dropdown = document.createElement('ul');
      dropdown.className = 'dropdown';
      dropdown.hidden = true;
      wrapper.appendChild(dropdown);

      let items = [], highlighted = -1;
      const MAX_SHOW = 200;

      const render = arr => {
        dropdown.innerHTML = '';
        if (!arr || !arr.length){ dropdown.hidden = true; return; }
        const frag = document.createDocumentFragment();
        arr.forEach((name, i)=>{
          const li = document.createElement('li');
          li.textContent = name;
          li.dataset.index = i;
          li.addEventListener('mousedown', e=>e.preventDefault());
          li.addEventListener('click', ()=> { choose(name); });
          frag.appendChild(li);
        });
        dropdown.appendChild(frag);
        dropdown.hidden = false;
        highlighted = -1;
      };

      const choose = name => { countryInput.value = name; dropdown.hidden = true; compute(); };

      const showMatches = q => {
        const qn = normalize(q || countryInput.value);
        let res;
        if (!qn) res = countries.slice(0, MAX_SHOW);
        else {
          const seen = new Set(); res = [];
          for (const c of countries){
            const lc = c.toLowerCase();
            if (lc.startsWith(qn) && !seen.has(lc)){ res.push(c); seen.add(lc); if (res.length>=MAX_SHOW) break; }
          }
          if (res.length < MAX_SHOW) for (const c of countries){
            const lc = c.toLowerCase();
            if (!seen.has(lc) && lc.includes(qn)){ res.push(c); seen.add(lc); if (res.length>=MAX_SHOW) break; }
          }
        }
        items = res;
        render(res);
      };

      const debouncedShow = debounce(showMatches, 120);

      countryInput.addEventListener('focus', ()=> showMatches());
      countryInput.addEventListener('click', e=>{ e.stopPropagation(); showMatches(); });
      countryInput.addEventListener('input', ()=> debouncedShow(countryInput.value));

      countryInput.addEventListener('keydown', e=>{
        if (dropdown.hidden) return;
        const lis = dropdown.querySelectorAll('li');
        if (!lis.length) return;
        if (e.key === 'ArrowDown'){ e.preventDefault(); highlighted = Math.min(highlighted+1, lis.length-1); updateHighlight(lis); }
        else if (e.key === 'ArrowUp'){ e.preventDefault(); highlighted = Math.max(highlighted-1, 0); updateHighlight(lis); }
        else if (e.key === 'Enter'){ e.preventDefault(); const sel = lis[highlighted] || lis[0]; if (sel) choose(sel.textContent); }
        else if (e.key === 'Escape'){ dropdown.hidden = true; highlighted = -1; }
      });

      function updateHighlight(lis){
        lis.forEach(li=>li.removeAttribute('aria-selected'));
        if (highlighted >= 0 && lis[highlighted]) { lis[highlighted].setAttribute('aria-selected','true'); lis[highlighted].scrollIntoView({block:'nearest'}); }
      }

      document.addEventListener('click', e=>{ if (!e.target.closest(wrapper)) dropdown.hidden = true; });
      window.addEventListener('resize', ()=>{ if (!dropdown.hidden) showMatches(); });
    })();

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{ loadData(); bindEvents(); updateFormulaFields(); compute(); });
  </script>
</body>
</html>
